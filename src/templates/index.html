{% extends 'base.html' %}
{% block title %}Home{% endblock %}
{%block scripts %}
<script src="/static/js/edit.js"></script>
<script src="/static/js/pin.js"></script>
{% endblock %}
{% block body %}
<div id="info">
    {% if uploads==[] %}
    <div class="term">
        <h2>Nothing here yet...</h2>
    </div>
    {% endif %}
    <div class="processing-status">
        <h1>Processing...</h1>
    </div>
</div>

<div id="all-items">

{% for item in uploads %}

{% if loop.first %}

<div class="term featured"
     style="cursor:pointer"
     id="{{ item.display_datetime[1] }}">

    {% if item.pin %}
    <span class="pin-icon">
        <img style="height:2em" src="/static/images/pin.gif">
    </span>
    {% endif %}

    <div class="meta">
        <span class="user">{{ user }}</span> |
        <span class="display-datetime">{{ item.display_datetime[0] }}</span> |
        <span class="ago" data-timestamp="{{ item.display_datetime[1] }}"></span> |
        <a class="url" href="#{{ item.display_datetime[1] }}">#{{ item.display_datetime[1] }}</a>
    </div>

    <span>
        file:
        <a class="url" href="{{ item.url }}" target="_blank">
            {{ item.name }}
        </a>

        {% if session.get('logged_in') %}
        &nbsp;
        <a href="#" class="delete-link" data-filename="{{ item.name }}">[delete]</a>
        &nbsp;
        <a href="#" class="edit-link" data-filename="{{ item.name }}">[edit]</a>
        &nbsp;
        <a href="#" class="pin-link" data-filename="{{ item.name }}">
            {% if item.pin %}[unpin]{% else %}[pin]{% endif %}
        </a>
        {% endif %}
    </span>

    <div class="media">
        <img src="{{ item.url }}">
    </div>

    <pre style="white-space: pre-wrap;" class="description">
<h2 onclick="location.href='/post/{{ item.title|urlencode }}'"><u>{{ item.title }}</u></h2>
{{ item.description|striptags|truncate(250, True, '...') }}
    </pre>

</div>

<div class="thumb-row">

{% else %}


    <!-- THUMB POSTS -->

    <div class="thumb-post"
    data-filename="{{ item.name }}">
        <img src="{{ item.url }}">
        <div class="thumb-overlay">
        {% if session.get('logged_in') %}
        <a href="#" class="delete-link" data-filename="{{ item.name }}">[delete]</a>
        &nbsp;
        {% if item.pin %}ðŸ“Œ{% endif %}<b onclick="location.href='/post/{{ item.title|urlencode }}'">{{ item.title }}</b>
        &nbsp;
        <a href="#" class="edit-link" data-filename="{{ item.name }}">[edit]</a>
        </a>
        {%else%}
        {% if item.pin %}ðŸ“Œ{% endif %}<b onclick="location.href='/post/{{ item.title|urlencode }}'">{{ item.title }}</b>
        {% endif %}
        </div>

    </div>

    {% endif %}

{% endfor %}

</div>

<!-- Edit Description + Date Modal -->
<div id="editModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; 
    background:#000000a1; justify-content:center; align-items:center; z-index:9999;">
    <div style="background:#1a1a1acb; padding:20px; border-radius:3px; width:350px; position:relative;border: 1px dashed #6d6d6d;">
        <h3>Edit Image</h3>
        <form id="editForm">
            <label for="editDescription">Description:</label>
            <textarea name="description" id="editTextarea" rows="6" style="width:100%;"></textarea>
            <label for="editDatetime">Date & Time:</label>
            <input type="datetime-local" name="display_datetime" id="editDatetime" style="width:100%;">
            <input type="hidden" name="filename" id="editFilename">
            <div style="margin-top:10px; text-align:right;">
                <button type="submit">Save</button>
                <button type="button" id="editCancel">Cancel</button>
            </div>
        </form>
    </div>
</div>

<div id="thumbMenu" style="
display:none;
position:fixed;
background:#000000dd;
border:1px solid #555;
padding:6px 10px;
z-index:9999;
font-size:13px;
cursor:pointer;">
Pin / Unpin
</div>
<script>
const menu = document.getElementById("thumbMenu");
let currentThumb = null;

document.querySelectorAll(".thumb-post").forEach(t => {
    t.addEventListener("contextmenu", e => {
        e.preventDefault();
        currentThumb = t;

        menu.style.left = e.pageX + "px";
        menu.style.top = e.pageY + "px";
        menu.style.display = "block";
    });
});

document.addEventListener("click", () => {
    menu.style.display = "none";
});

menu.addEventListener("click", () => {
    if(!currentThumb) return;

    const filename = currentThumb.dataset.filename;

    fetch(`/pin/${filename}`, {method:"POST"})
        .then(r=>r.json())
        .then(()=>{
            location.reload();
        });
});
</script>

{% endblock %}
